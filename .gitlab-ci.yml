stages:
  - test
  - release

variables:
  COUCHDB_USER: admin
  COUCHDB_PASSWORD: abc123

test:
  parallel:
    matrix:
      - GOVER: ["1.17", "1.18", "1.19", "1.20", "1.21", "1.22", "1.23", "1.24"]
  stage: test
  image: golang:$GOVER
  services:
    - docker:24-dind
  variables:
    USETC: "1"
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
  script:
    - go mod download
    - go test -race -shuffle=on ./...

coverage:
  stage: test
  image: golang:1.22
  services: []
  before_script:
    - ""
  script:
    - go mod download
    - ./script/coverage.sh

.releaser: &release_template
  image:
    name: goreleaser/goreleaser:v1.25.1
    entrypoint: [""]
  variables:
    GIT_DEPTH: 0

release-test:
  <<: *release_template
  stage: test
  script:
    - goreleaser check

release:
  <<: *release_template
  stage: release
  script:
    - goreleaser
  only:
    - /^v\d+\.\d+\.\d+/
