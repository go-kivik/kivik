# Kivik v5 Breaking Changes

## Confirmed

- [ ] **`Find()` signature change** ([#1015](https://github.com/go-kivik/kivik/issues/1015))
  Change `query any` to `json.RawMessage` in both `DB.Find()` and
  `driver.Finder.Find()`.

- [ ] **`DBUpdates` default behavior** (`couchdb/client.go:71`)
  Remove the implicit `feed=continuous&since=now` default. Use CouchDB's
  default (`feed=normal&since=`).

- [ ] **Merge `LastSeqer` into `DBUpdates`** (`driver/updates.go:35-36`)
  `LastSeq() (string, error)` becomes a required method on `driver.DBUpdates`.

- [ ] **Move `Ping` from DB to Client** (`x/sqlite/db.go:51`)
  `Pinger` currently extends `Client`, but some drivers (e.g. SQLite) implement
  it on DB. Clarify that Ping belongs on Client.

- [ ] **Merge `ClientCloser` into `Client`**
  `Close() error` should be a required method on `driver.Client`, not an
  optional interface. Neither CouchDB nor SQLite currently implements
  `ClientCloser`.

- [ ] **Fix or remove `Searcher` interface** (`driver/search.go`)
  Uses `map[string]any` instead of `driver.Options`. No driver implements it.
  Either fix the signature or remove it.

- [ ] **Remove `x/memorydb`**
  Made obsolete by `x/sqlite`.

- [ ] **Remove `x/proxydb`**
  Likely unused; has methods that panic with "should never be called".

- [ ] **Drop legacy CouchDB replication support**
  Remove `replication` struct, `legacyGetReplications`, `schedulerSupported()`
  detection, and `schedulerDetected`/`sdMU` from the client. Standardize on
  the `_scheduler/docs` API only (CouchDB >= 2.1). The legacy path is strictly
  worse: two HTTP calls per update, no progress reporting, no `changes_pending`.

- [ ] **Replication interface cleanup** (`driver/driver.go:94-133`)
  With only the scheduler implementation remaining, simplify
  `driver.Replication`: remove mutable-state getters (`State()`, `StartTime()`,
  `EndTime()`, `Err()`), merge `ReplicationInfo` into a new `ReplicationStatus`
  snapshot struct, and have `Update()` return `(*ReplicationStatus, error)`.

## Drop CouchDB 1.x Support

Raising the minimum supported CouchDB version enables several simplifications.
The items below assume a minimum of 2.1 (already implied by the replication
cleanup above). Items marked *(2.2+)* or *(3.x+)* require a higher minimum.

- [ ] **Simplify `Ping()`** (`couchdb/client.go:248-260`)
  Remove the 400 + `CouchDB/1.` header sniff. With 2.1+ minimum, `/_up`
  always returns 200, so `Ping` becomes a simple HEAD request.

- [ ] **Remove `couch1ConfigNode` path** (`couchdb/config.go:27-45`)
  Remove the `/_config` (1.x) vs `/_node/<node>/_config` (2.x+) branch.
  Config always goes through the per-node path. Remove the constant and
  related documentation in `couchdb/doc.go`.

- [ ] **Remove replication timestamp fallback** (`couchdb/replication.go:71-76`)
  Remove the Unix-epoch-seconds fallback for "really old versions". Only
  RFC3339 parsing is needed.

- [ ] **Remove `json.RawMessage` Go 1.7 case** (`couchdb/chttp/chttp.go:339`)
  Dead code — Go minimum is already 1.20. Not CouchDB-related, but a good
  cleanup to bundle here.

- [ ] **Remove multi-query fallback** *(2.2+)* (`couchdb/rows.go:240-269`)
  Remove the legacy single-query fallback when server doesn't return a
  `"results"` key. The `atomic.StoreInt32(&r.legacy, 1)` path and the
  stream-reassembly hack go away.

- [ ] **Remove `DBsStats`/`AllDBsStats` fallback** *(2.2+)* (`kivik.go:183-274`)
  The `_dbs_info` endpoint was added in 2.2. Remove the N+1
  individual-stats fallback paths.

- [ ] **Remove 1.x test fixtures**
  Delete CouchDB 1.6.1/1.7.1 response fixtures and test cases across
  `couchdb/` test files.

## For consideration

- [ ] **Sentinel errors for "not really errors"**
  Add `ErrNotFound` (404) and `ErrConflict` (409) sentinels with
  status-code-based `Is()` methods, so users can write
  `errors.Is(err, kivik.ErrNotFound)` instead of
  `kivik.HTTPStatus(err) == 404`. These two mirror the `io.EOF` /
  `sql.ErrNoRows` pattern — expected outcomes that travel through the error
  channel. Keep `HTTPStatus()` and the unexported `statusCoder` interface
  as-is for everything else. Don't export the interface; don't add sentinels
  for genuine errors (401, 403, 500, etc.).

- [ ] **Minimum CouchDB version**
  CouchDB 2.x has been EOL since 2020. A 3.x minimum would enable all the
  simplifications above. The question is whether anyone still uses Kivik
  against a 2.x instance.
